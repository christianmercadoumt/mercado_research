---
title: "Untitled"
author: "Christian Mercado"
date: '2022-07-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r get data}
#get data
library(gratia)
library(tidyverse)
library(mgcv)
library(gridExtra)
source('12.gam_fns.R')

hab_loc_codes <- read_csv('data/habtypes.csv')
hab_loc_codes <- hab_loc_codes %>% select(SETTING_ID, habclass, locationcode)
bai.train <- readRDS('data/bai.train.7_14_22.rds')
bai.train <- left_join(bai.train, hab_loc_codes, by = "SETTING_ID")

bai.spmx <- bai.train %>% 
  select(SETTING_ID, stand, MEASUREMENT_NO, myear, PLOT, cluster, unique_tree_id, 
         bai, DIAMETER, treeba, log.diam, log.bai, grwth.yr, mean_si, aspect_deg, 
         heatload, slope_deg, elev_m, NF, CROWN_RATIO, tpa.pl.all, tpa.pl.cutoff,
         ba.pl, bal.pl, ccf.pl, ccf.nospp, qmd.pl.all, qmd.pl.cutoff, dq.pl.all, 
         dq.pl.cutoff, tpa.cl.all, tpa.pl.cutoff,
         ba.cl, ccf.cl, bal.cl, dq.cl.all, dq.cl.cutoff, HabType, habclass,
         locationcode, percent_LAOC, shade.tol.pl, dom.spp.pl.ba, percent_PSME, 
         percent_PIEN, percent_ABLA, percent_ABGR, percent_PICO, percent_PIPO, percent_other) %>% 
  mutate(slope_pct = tan(slope_deg*(pi/180))*100, 
         asp_sin = sin(aspect_deg*(pi/180)),
         asp_cos = cos(aspect_deg*(pi/180))) %>%
  mutate(sl_asp_sin = asp_sin*slope_pct, 
         sl_asp_cos = asp_cos*slope_pct, 
         asp.trasp = trasp(aspect_deg), 
         HabType = as.factor(HabType),
         cr = CROWN_RATIO/100,
         bal.pl.ratio = bal.pl/ba.pl,
         unique_tree_id = factor(unique_tree_id)) %>% 
  filter(bai != 0)


bai.spmx.ids <- bai.spmx %>% 
  group_by(stand) %>% 
  mutate(unique.stand = cur_group_id()) %>%
  ungroup() %>% 
  mutate(unique.cluster = (1000*unique.stand)+cluster, 
         unique.plot = (1000*unique.stand)+PLOT) %>% 
  mutate(unique.cluster.meas = as.factor(unique.cluster + MEASUREMENT_NO), 
         unique.plot.meas = as.factor(unique.plot + MEASUREMENT_NO),
         unique.cluster.f = as.factor(unique.cluster), 
         unique.plot.f = as.factor(unique.plot), 
         unique.tree.f = as.factor(unique_tree_id)) %>% 
  filter(unique_tree_id != 15431)

bai.train <- readRDS('data/bai.train.7_14_22.rds')
bai.hold <- readRDS('data/bai.hold.7_14_22.rds')
full.data <- bind_rows(bai.train, bai.hold)

#identify mixtures
spp.fun <- function(data.set, spp_min, spp_maximum, combined_min){
  a <- data.set %>% filter(percent_LAOC<spp_maximum & percent_LAOC>spp_min, 
                               percent_PSME<spp_maximum & percent_PSME>spp_min, 
                               (percent_LAOC+percent_PSME)>combined_min) %>% 
    mutate(other.pct = percent_PSME)
  b <- data.set %>% filter(percent_LAOC<spp_maximum & percent_LAOC>spp_min, 
                               percent_ABLA<spp_maximum & percent_ABLA>spp_min, 
                               (percent_LAOC+percent_ABLA)>combined_min) %>% 
    mutate(other.pct = percent_ABLA)
  c <- data.set %>% filter(percent_LAOC<spp_maximum & percent_LAOC>spp_min, 
                               percent_ABGR<spp_maximum & percent_ABGR>spp_min, 
                               (percent_LAOC+percent_ABGR)>combined_min) %>% 
    mutate(other.pct = percent_ABGR)
  d <- data.set %>% filter(percent_LAOC<spp_maximum & percent_LAOC>spp_min, 
                               percent_PIEN<spp_maximum & percent_PIEN>spp_min, 
                               (percent_LAOC+percent_PIEN)>combined_min) %>% 
    mutate(other.pct = percent_PIEN)
  e <- data.set %>% filter(percent_LAOC<spp_maximum & percent_LAOC>spp_min, 
                               percent_PICO<spp_maximum & percent_PICO>spp_min, 
                               (percent_LAOC+percent_PICO)>combined_min) %>% 
    mutate(other.pct = percent_PICO)
  f <- data.set %>% filter(percent_LAOC<spp_maximum & percent_LAOC>spp_min, 
                               percent_PIPO<spp_maximum & percent_PIPO>spp_min, 
                               (percent_LAOC+percent_PIPO)>combined_min) %>% 
    mutate(other.pct = percent_PIPO)
  g <- data.set %>% filter(percent_LAOC>0.9) %>% 
    mutate(other.pct = percent_LAOC)
   return(list('psme'=a, 'abla'=b, 'abgr'=c, 'pien'=d, 'pico'=e, 'pipo'=f, 'laoc' = g))
  }

```


```{r all data mixtures}
mix.data <- spp.fun(full.data, 0.2, .65, 0.7)

full.mix <- bind_rows(mix.data, .id = 'id')

full.mix %>% group_by(id, NF, stand) %>% summarize(num.obs = n())

bai.diam <- full.mix %>% 
  group_by(NF, stand, PLOT, id, unique_tree_id) %>% 
  summarise(meanbai = mean(bai), meandbh = mean(DIAMETER))

ggplot(bai.diam, aes(x = meandbh, y = meanbai)) + geom_point() + geom_smooth(se = F) + facet_wrap(~id)

```

```{r mixture analysis figs.}
#make data
(mixtures <- spp.fun(bai.spmx.ids, 0.2, .65, 0.7))

full.mix <- bind_rows(mixtures, .id = 'id')

#mixtures_summary#####.
mixtures.all <- full.mix %>%  
  mutate(laoc_to_other = case_when(percent_LAOC/other.pct >= 1 ~ (percent_LAOC/other.pct),
                                   percent_LAOC/other.pct < 1 ~ (other.pct/percent_LAOC))) %>% 
  ungroup() %>% 
  mutate(more.larch = case_when(percent_LAOC/other.pct >= 1 ~ 'yes',
                                percent_LAOC/other.pct < 1 ~ 'no'))
ggplot(subset(mixtures.all, !(id %in% c('abla', 'laoc', 'pipo'))), 
       aes(x = id, y = laoc_to_other)) + 
  geom_jitter(alpha = 0.5, aes(color = more.larch))

#mixes average.tree.bai-avg.tree.diam smoothed by type#####


bai.diam <- full.mix %>% 
  group_by(NF, stand, PLOT, id, unique_tree_id) %>% 
  summarise(meanbai = mean(bai), meandbh = mean(DIAMETER))

ggplot(bai.diam, aes(x = meandbh, y = meanbai, color = id)) + geom_point(alpha = 0.2) + geom_smooth(se = F)
ggplot(bai.diam, aes(x = meandbh, y = meanbai)) + geom_point() + geom_smooth(se = F) + facet_wrap(~id)
ggplot(subset(bai.diam, id %in% c('laoc', 'psme')), 
       aes(x = meandbh, y = meanbai, color = id)) +
  geom_point(alpha = 0.2) + 
  geom_smooth(se = F)
ggplot(subset(bai.diam, id %in% c('laoc', 'pico')), 
       aes(x = meandbh, y = meanbai, color = id)) +
  geom_point(alpha = 0.2) + 
  geom_smooth(se = F)
ggplot(subset(bai.diam, id %in% c('laoc', 'pien')), 
       aes(x = meandbh, y = meanbai, color = id)) +
  geom_point(alpha = 0.2) + 
  geom_smooth(se = F)
ggplot(subset(bai.diam, id %in% c('laoc', 'pipo')), 
       aes(x = meandbh, y = meanbai, color = id)) +
  geom_point(alpha = 0.2) + 
  geom_smooth(se = F)
ggplot(subset(bai.diam, id %in% c('laoc', 'abla')), 
       aes(x = meandbh, y = meanbai, color = id)) +
  geom_point(alpha = 0.2) + 
  geom_smooth(se = F)

```

```{r mixtures figs}


library(ggforce)
(mixtures <- spp.fun(bai.spmx.ids, 0.2, .65, 0.7))

#add names to mixtures
mix.w.names <- map(names(mixtures), ~mixtures[[.x]] %>% mutate(mixtype = .x))

lapply(mix.w.names, function(x){x %>% summarise()})
#combine data in list
mixtures.all <- bind_rows(mix.w.names)
#create factor
o.mixtures.all <- mixtures.all %>% 
  select(SETTING_ID, stand, PLOT, bai, DIAMETER, 
         cr, bal.pl.ratio, ba.pl, asp_sin, asp_cos, 
         mixtype, unique_tree_id) %>% 
  filter(mixtype %in% c('psme', 'pien', 'pico', 'laoc')) %>% 
  mutate(mixtype = as.factor(mixtype)) %>% 
  mutate(omixtype = ordered(mixtype, levels = c('laoc', 'pico', 'psme', 'pien')))
o.mixtures.nopien <- o.mixtures.all %>% filter(omixtype != 'pien') %>% mutate(omixtype = droplevels(omixtype))

#what I really want is a table that is grouped by mixtype
## and then grouped below into max, min, mean, sd, num.obs
# every row is a variable



#squareft to msquared - 10.76392ft^2 = 1m^2
#acres to ha - 2.471052acre = 1ha
#ft^2/acre -> m^2/ha = 2.471052/10.76392 
# histogram for each mixture
ggplot(o.mixtures.nopien, aes(x = (ba.pl*0.229568),
                           color = omixtype, fill = omixtype)) +
  geom_histogram(position = 'identity', alpha = 0.2) +
  labs(y = '# of obs', x = 'Plot basal area (sqm/ha)')
# density plot for each mixture
# ggplot(o.mixtures.all, aes(x = (ba.pl*0.229568), color = omixtype, fill = omixtype,
#                            after_stat(count/sum(count)))) + 
#   geom_density(position = 'identity', alpha = 0.2) +
#   labs(y = 'Proportion of total observations', x = 'Plot basal area (m/ha)')

#histogram for diameter
ggplot(o.mixtures.nopien, aes(x = DIAMETER*2.54, color = omixtype, fill = omixtype)) +
  geom_histogram(position = 'identity', alpha = 0.2) +
  labs(y = 'Number of observations', x = 'DBH(cm)')

ggplot(o.mixtures.nopien, aes(x = bai*2.54^2, color = omixtype, fill = omixtype)) +
  geom_histogram(position = 'identity', alpha = 0.2) +
  labs(y = 'Number of observations', x = 'bai(cmsq/yr)')

# create compasses - see if i can make point sizes correspond to amount of data at each?
comp <- o.mixtures.nopien %>% 
  group_by(mixtype, asp_sin, asp_cos) %>% 
  mutate(mixtype = case_when(mixtype == 'laoc' ~ 'Pure larch',
                             mixtype == 'pico' ~ 'Larch-lodgepole',
                             mixtype == 'psme' ~ 'Larch-Douglas-fir')) %>% 
  summarise(n_distinct(stand), n()) # subset data to have one row per aspect

nsew <- c('N', 'S', 'E', 'W', 'NW', 'NE', 'SW', 'SE') # for label
nsew.v <- c(0, 180, 90, 270, 315, 45, 225, 135) # aspect values
ns.df <- tibble(nsew, nsew.v) #combine
ns.df <- ns.df %>% 
  mutate(sin.t = sin(nsew.v*pi/180), 
         cos.t = cos(nsew.v*pi/180)) #transform



(comp.psme <- ggplot(comp, aes(x = asp_sin, y = asp_cos)) + #build compass
  geom_hline(yintercept = 0) + #horizontal 
  geom_vline(xintercept = 0) + #vertical
  geom_circle(inherit.aes = F, aes(x0=0, y0=0, r=1)) + #make circle
  geom_text(aes(x = -1, y = 1, label = 'C')) +
  geom_label(data = ns.df, aes(x = sin.t, y = cos.t, label = nsew)) +
  geom_point(alpha = 0.6, size = 4) +# points for each aspect
  facet_wrap_paginate(~mixtype, nrow = 1, ncol = 1, page = 1) + # facet by mixture type
  theme(axis.ticks = element_blank(), 
        axis.text = element_blank(), 
        axis.title = element_blank(), 
        axis.line = element_blank(),
        line = element_blank(),
        strip.text.x = element_text(size = 12)))
comp.psme
ggsave('17.figures_saved/compass_psme.png')

comp.pico <-  ggplot(comp, aes(x = asp_sin, y = asp_cos)) + #build compass
  geom_hline(yintercept = 0) + #horizontal 
  geom_vline(xintercept = 0) + #vertical
  geom_circle(inherit.aes = F, aes(x0=0, y0=0, r=1)) + #make circle
  geom_text(aes(x = -1, y = 1, label = 'B')) +
  geom_label(data = ns.df, aes(x = sin.t, y = cos.t, label = nsew)) + #label
  geom_point(alpha = 0.6, size = 4) + # points for each aspect
  facet_wrap_paginate(~mixtype, nrow = 1, ncol = 1, page = 2) + # facet by mixture type
  theme(axis.ticks = element_blank(), 
        axis.text = element_blank(), 
        axis.title = element_blank(), 
        axis.line = element_blank(),
        line = element_blank())
comp.pico
ggsave('17.figures_saved/compass_pico.png')

comp.laoc <-  ggplot(comp, aes(x = asp_sin, y = asp_cos)) + #build compass
  geom_hline(yintercept = 0) + #horizontal 
  geom_vline(xintercept = 0) + #vertical
  geom_circle(inherit.aes = F, aes(x0=0, y0=0, r=1)) + #make circle
  geom_text(aes(x = -1, y = 1, label = 'A')) +
  geom_label(data = ns.df, aes(x = sin.t, y = cos.t, label = nsew)) + #label
  geom_point(alpha = 0.6, size = 4) + # points for each aspect
  facet_wrap_paginate(~mixtype, nrow = 1, ncol = 1, page = 3) + # facet by mixture type
  theme(axis.ticks = element_blank(), 
        axis.text = element_blank(), 
        axis.title = element_blank(), 
        axis.line = element_blank(),
        line = element_blank())
comp.laoc
ggsave('17.figures_saved/compass_laoc.png')

grid.arrange(comp.laoc, comp.pico, comp.psme, )

ggplot(comp, aes(x = asp_sin, y = asp_cos)) + #build compass
  geom_hline(yintercept = 0) + #horizontal 
  geom_vline(xintercept = 0) + #vertical
  geom_circle(inherit.aes = F, aes(x0=0, y0=0, r=1)) + #make circle
  geom_label(data = ns.df, aes(x = sin.t, y = cos.t, label = nsew)) + #label
  geom_point(alpha = 0.6, size = 4) + # points for each aspect
  facet_wrap(~mixtype, nrow = 3, ncol = 1) + # facet by mixture type
  theme(axis.ticks = element_blank(), 
        axis.text = element_blank(), 
        axis.title = element_blank(), 
        axis.line = element_blank(),
        line = element_blank())
```

```{r mixtures partial response}
library(tidymv)

mix.diff.nopien <- readRDS('data/model_objects.1/mix.diff.nopien.rds')

summary(mix.diff.nopien)
mix.diff.nopien

tidymv::get_smooths_difference(mix.diff.nopien, DIAMETER, list(omixtype = c('laoc', 'psme')))
tidymv::get_smooths_difference(mix.diff.nopien, DIAMETER, list(omixtype = c('laoc', 'pico')))

plot_smooths(mix.diff.nopien, DIAMETER, comparison = omixtype)

plot.gamViz(mix.diff.nopien)
par(mfrow = c(2,2))
plot.gam(mix.diff.nopien, scale = 0, shade = T, seWithMean = T, select = c(1), xlab = 'DBH')
plot.gam(mix.diff.nopien, scale = 0, shade = T, seWithMean = T, select = 2)
plot.gam(mix.diff.nopien, scale = 0, shade = T, seWithMean = T, select = 3)
plot.gam(mix.diff.nopien, scale = 0, shade = T, seWithMean = T, select = 4)

# viz.1 <- getViz(mix.diff.gam.m1)
# plot(viz.1)

smest.diam <- smooth_estimates(mix.diff.nopien, smooth = 's(DIAMETER)', partial_match = T) %>% add_confint() %>% 
  mutate(est = exp(est), se = exp(se), DBH.cm = DIAMETER*2.54, lower_ci = exp(lower_ci), upper_ci = exp(upper_ci))

ggplot(smest.diam, aes(x = DBH.cm, y = est, color = omixtype, ymin = lower_ci, ymax = upper_ci)) + 
  geom_line() + geom_ribbon(alpha = 0.2) + scale_y_continuous(limits = c(0, 10))


gam.check(mix.diff.nopien)
draw(mix.diff.gam.m1)
draw


```


